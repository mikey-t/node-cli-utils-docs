#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';
import Swig, { log, possibleTaskFileNames, red, trace, yellow } from './Swig.js';
import { spawn } from 'node:child_process';
export default class SwigStartupWrapper {
    swigfilePath = '';
    swigfileName = '';
    packageJsonType = 'commonjs';
    swigfileExtension = 'js';
    hasTsx = false;
    constructor() { }
    main() {
        trace('- SwigStartupWrapper is checking a few things...');
        const hasSwigfile = this.populateSwigfile();
        if (hasSwigfile) {
            trace(`- swigfile: ${this.swigfilePath}`);
            trace(`- swigfile extension: ${this.swigfileExtension}`);
        }
        this.populatePackageJsonTypeOrThrow();
        trace(`- package.json type: ${this.packageJsonType}`);
        if (hasSwigfile) {
            this.warnIfPossibleSwigfileSyntaxMismatch();
        }
        else {
            trace(`- swigfile not found - skipping syntax check`);
        }
        return this.spawnSwig();
    }
    async spawnSwig() {
        const preservedArgs = process.argv.slice(2);
        const isTypescript = this.swigfileExtension === 'ts';
        const swigScriptEsm = './node_modules/swig-cli/dist/esm/swigCli.js';
        const swigScriptCjs = './node_modules/swig-cli/dist/cjs/swigCli.cjs';
        const tsNodeBinCjs = './node_modules/ts-node/dist/bin.js';
        const tsNodeBinEsm = './node_modules/ts-node/dist/bin-esm.js';
        let swigScript = swigScriptEsm;
        let tsNodeBin = tsNodeBinEsm;
        if (isTypescript && this.packageJsonType === 'esm') {
            swigScript = swigScriptEsm;
            tsNodeBin = tsNodeBinEsm;
        }
        else if (isTypescript && this.packageJsonType === 'commonjs') {
            swigScript = swigScriptCjs;
            tsNodeBin = tsNodeBinCjs;
        }
        if (isTypescript && !this.hasTsx && !fs.existsSync(tsNodeBin)) {
            this.exitWithError(`typescript detected but a dev dependency is missing.\nChoose and install either ts-node or tsx using 'npm i -D ts-node' or 'npm i -D tsx' (note that tsx esm functionality is experimental).`);
        }
        const command = 'node';
        let spawnArgs = [swigScript, ...preservedArgs];
        if (isTypescript && this.hasTsx) {
            spawnArgs = ['--no-warnings', '--loader', 'tsx', ...spawnArgs];
        }
        else if (isTypescript) {
            spawnArgs = [tsNodeBin, '-T', swigScript, ...preservedArgs];
        }
        trace(`- swig-cli spawn command: ${command} ${spawnArgs.join(' ')}`);
        return this.spawnSwigCliAsync(command, spawnArgs);
    }
    populateSwigfile() {
        let swigfilePath;
        for (const filename of possibleTaskFileNames) {
            swigfilePath = `./${filename}`;
            if (fs.existsSync(swigfilePath)) {
                this.swigfilePath = swigfilePath;
                this.swigfileName = path.basename(this.swigfilePath);
                this.swigfileExtension = this.swigfileName.split('.')[1];
                return true;
            }
        }
        return false;
    }
    populatePackageJsonTypeOrThrow() {
        const packageJsonPath = './package.json';
        if (!fs.existsSync(packageJsonPath)) {
            this.exitWithError('no package.json found - cannot detect project type');
        }
        const packageJsonContents = fs.readFileSync(packageJsonPath, { encoding: 'utf-8' });
        const packageJson = JSON.parse(packageJsonContents);
        this.packageJsonType = packageJson.type && packageJson.type.toLowerCase() === 'module' ? 'esm' : 'commonjs';
        // Check that swig-cli is installed as a dependency or devDependency
        if ((packageJson.devDependencies && packageJson.devDependencies['swig-cli']) || (packageJson.dependencies && packageJson.dependencies['swig-cli'])) {
            trace('- swig-cli is installed as a dependency in the project');
        }
        else {
            this.exitWithError(`swig-cli was not found in the project dependencies or devDependencies - install with: npm i -D swig-cli`);
        }
        if ((packageJson.devDependencies && packageJson.devDependencies['tsx']) || (packageJson.dependencies && packageJson.dependencies['tsx'])) {
            this.hasTsx = true;
            trace('- tsx is installed as a dependency in the project');
        }
    }
    warnIfPossibleSwigfileSyntaxMismatch() {
        const swigfileContents = fs.readFileSync(this.swigfilePath, { encoding: 'utf-8' });
        if (swigfileContents.trim() === '')
            return;
        if (!swigfileContents) {
            throw new Error(`Error parsing swigfile ${this.swigfilePath}`);
        }
        const swigfileContentsWithoutComments = this.stripComments(swigfileContents);
        const hasEsmSyntax = this.fileStringHasEsm(swigfileContentsWithoutComments);
        const hasCommonJsSyntax = this.fileStringHasCommonJs(swigfileContentsWithoutComments);
        const hasBoth = hasEsmSyntax && hasCommonJsSyntax;
        // Don't warn - it might just be a new project with nothing exported or imported yet
        if (!hasEsmSyntax && !hasCommonJsSyntax)
            return;
        // Typescript allows both cjs and esm syntax, even mixed - as long as the package.json type is commonjs
        if (this.swigfileExtension === 'ts' && this.packageJsonType === 'commonjs')
            return;
        if (this.swigfileExtension === 'ts' && this.packageJsonType === 'esm' && (hasBoth || hasCommonJsSyntax)) {
            this.logWarning(`${this.swigfileName} needs to use only ESM syntax if the package.json type is set to "module".`);
            this.logOptionsMatrix();
            return;
        }
        if (hasBoth) {
            this.logWarning(`${this.swigfileName} appears to have both ESM and CommonJS syntax, but it should have only one or the other.`);
            this.logOptionsMatrix();
            return;
        }
        if (this.swigfileExtension === 'mjs' && hasEsmSyntax && !hasCommonJsSyntax)
            return;
        if (this.swigfileExtension === 'cjs' && !hasEsmSyntax && hasCommonJsSyntax)
            return;
        if (this.swigfileExtension === 'js' && this.packageJsonType === 'esm' && hasEsmSyntax)
            return;
        if (this.swigfileExtension === 'js' && this.packageJsonType === 'commonjs' && hasCommonJsSyntax)
            return;
        if (this.swigfileExtension === 'ts' && this.packageJsonType === 'commonjs')
            return;
        if (this.swigfileExtension === 'ts' && this.packageJsonType === 'esm' && hasEsmSyntax)
            return;
        this.logWarning(`${this.swigfileExtension} appears to use ${hasEsmSyntax ? 'ESM' : 'CommonJS'} syntax and your package.json type is set to ${this.packageJsonType}.`);
        this.logOptionsMatrix();
    }
    fileStringHasEsm(fileContent) {
        const esmPatterns = [
            /^\s*import\s+\w+\s+from\s+['"].+['"]/m,
            /^\s*import\s*\{[^}]+\}\s+from\s+['"].+['"]/m,
            /^\s*export\s+const\s+\w+/m,
            /^\s*export\s+default\s+\w+/m,
            /^\s*export\s+function\s+\w+/m,
            /^\s*export\s+class\s+\w+/m // export class x
        ];
        return esmPatterns.some(pattern => pattern.test(fileContent));
    }
    fileStringHasCommonJs(fileContent) {
        const commonJsPatterns = [
            /^\s*const\s+\w+\s+=\s+require\(['"].+['"]\)/m,
            /^\s*module\.exports\s+=/m,
            /^\s*exports\.\w+\s+=/m // exports.x =
        ];
        return commonJsPatterns.some(pattern => pattern.test(fileContent));
    }
    stripComments(content) {
        return content.replace(/\/\/.*$|\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm, '');
    }
    logWarning(str) {
        log(`\n${yellow('[swig-cli] Warning:')} ${str}`);
    }
    exitWithError(message) {
        log(`${red('[swig-cli] Error:')} ${message}`);
        process.exit(1);
    }
    logOptionsMatrix() {
        const optionsData = [
            ['swigfile', 'package.json type', 'syntax', 'notes'],
            ['.cjs', 'any', 'CommonJS', ''],
            ['.mjs', 'any', 'ESM', ''],
            ['.js', 'module', 'ESM', ''],
            ['.js', 'commonjs', 'CommonJS', ''],
            ['.ts', 'module', 'ESM', 'can be affected by tsconfig.json settings'],
            ['.ts', 'commonjs', 'CommonJS and/or ESM', 'can be affected by tsconfig.json settings']
        ];
        log('\nAvailable configurations:\n');
        this.logTable(optionsData);
        log('');
    }
    logTable(data) {
        if (data.length === 0 || data[0].length === 0)
            return;
        const numColumns = data[0].length;
        const columnWidths = [];
        for (let i = 0; i < numColumns; i++) {
            columnWidths[i] = Math.max(...data.map(row => row[i]?.length || 0));
        }
        const lineSeparator = ' ' + columnWidths.map(width => '-'.repeat(width)).join(' + ');
        for (let i = 0; i < data.length; i++) {
            const paddedRowArray = data[i].map((cell, colIdx) => cell.padEnd(columnWidths[colIdx], ' '));
            log(' ' + paddedRowArray.join(' | '));
            if (i === 0)
                log(lineSeparator);
        }
    }
    spawnSwigCliAsync(command, args) {
        return new Promise((resolve) => {
            const result = { code: 1 };
            const prefix = `[spawnSwigCliAsync] `;
            const child = spawn(command, args, { stdio: 'inherit' });
            const childId = child.pid;
            if (!childId) {
                throw new Error(`${prefix}Error spawning ChildProcess`);
            }
            const exitListener = (code) => {
                child.kill();
                child.unref();
                result.code = code;
                resolve(result);
            };
            process.on('exit', exitListener);
            const signals = ['SIGINT', 'SIGTERM', 'SIGQUIT'];
            const signalListener = (signal) => {
                trace(`${prefix}Process received ${signal} - killing ChildProcess with ID ${childId}`);
                child.kill(signal);
            };
            signals.forEach((signal) => {
                process.on(signal, signalListener);
            });
            child.on('exit', (code, signal) => {
                trace(`${prefix}ChildProcess exited with code ${code} and signal ${signal}`);
                result.code = code ?? 1;
                process.removeListener('exit', exitListener);
                signals.forEach((signal) => {
                    process.removeListener(signal, signalListener);
                });
                child.removeAllListeners();
                resolve(result);
            });
            child.on('error', (error) => {
                trace(`${prefix}ChildProcess emitted an error event: `, error);
            });
        });
    }
}
const firstArg = process.argv.slice(2)[0];
if (['h', 'help', '-h', '--help', 'v', 'version', '-v', '--version'].includes(firstArg)) {
    // If first arg is version or help, skip all checks and go straight to
    // calling Swig since all it needs to do is print some text and exit.
    trace(`- SwigStartupWrapper is skipping checks because the command is ${firstArg}`);
    new Swig().runMainAsync();
}
else {
    new SwigStartupWrapper().main()
        .then((result) => {
        if (result.error) {
            console.error(result.error);
        }
        process.exit(result.code);
    }).catch(err => {
        console.error(err);
        process.exit(42);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3dpZ1N0YXJ0dXBXcmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL1N3aWdTdGFydHVwV3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ3hCLE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQTtBQUM1QixPQUFPLElBQUksRUFBRSxFQUFFLEdBQUcsRUFBRSxxQkFBcUIsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUNoRixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFLMUMsTUFBTSxDQUFDLE9BQU8sT0FBTyxrQkFBa0I7SUFDN0IsWUFBWSxHQUFXLEVBQUUsQ0FBQTtJQUN6QixZQUFZLEdBQVcsRUFBRSxDQUFBO0lBQ3pCLGVBQWUsR0FBZ0IsVUFBVSxDQUFBO0lBQ3pDLGlCQUFpQixHQUFzQixJQUFJLENBQUE7SUFDM0MsTUFBTSxHQUFZLEtBQUssQ0FBQTtJQUUvQixnQkFBZ0IsQ0FBQztJQUVqQixJQUFJO1FBQ0YsS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUE7UUFFekQsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUE7UUFDM0MsSUFBSSxXQUFXLEVBQUU7WUFDZixLQUFLLENBQUMsZUFBZSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQTtZQUN6QyxLQUFLLENBQUMseUJBQXlCLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUE7U0FDekQ7UUFFRCxJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQTtRQUNyQyxLQUFLLENBQUMsd0JBQXdCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFBO1FBRXJELElBQUksV0FBVyxFQUFFO1lBQ2YsSUFBSSxDQUFDLG9DQUFvQyxFQUFFLENBQUE7U0FDNUM7YUFBTTtZQUNMLEtBQUssQ0FBQyw4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