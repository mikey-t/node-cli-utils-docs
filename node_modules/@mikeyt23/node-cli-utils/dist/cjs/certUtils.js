"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.linuxInstallCert = exports.winGetPfxInfo = exports.winUninstallCert = exports.winCertIsInstalled = exports.winInstallCert = exports.generateCertWithOpenSsl = void 0;
const node_fs_1 = __importDefault(require("node:fs"));
const promises_1 = __importDefault(require("node:fs/promises"));
const node_path_1 = __importDefault(require("node:path"));
const generalUtils_js_1 = require("./generalUtils.js");
const colors_js_1 = require("./colors.js");
const defaultCertLogOptions = {
    logSpawnOutput: false,
    logTraceMessages: false,
    logElevatedPermissionsMessage: true,
    logSuccess: true
};
/**
 * Wrapper function for calling openssl to generate a self-signed cert to be used for developing a local website with trusted https.
 * @param url The url to generate a cert for. This will be used as the common name (CN) in the cert as well as the filename for the generated cert files.
 * @param options Options for generating the cert.
 * @returns The path to the generated pfx file.
 */
async function generateCertWithOpenSsl(url, options) {
    (0, generalUtils_js_1.requireString)('url', url);
    throwIfMaybeBadUrlChars(url);
    const isMac = (0, generalUtils_js_1.isPlatformMac)();
    const mergedOptions = { ...defaultCertLogOptions, outputDirectory: './cert', ...options };
    const spawnArgs = { cwd: mergedOptions.outputDirectory, stdio: mergedOptions.logSpawnOutput ? 'inherit' : 'pipe' };
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, 'checking if openssl is installed');
    let brewOpenSslPath = '';
    if (!isMac) {
        const openSslPath = (0, generalUtils_js_1.whichSync)('openssl').location;
        if (!openSslPath) {
            throw Error('openssl is required but was not found');
        }
        (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `using openssl at: ${openSslPath}`);
    }
    else if (isMac) {
        const brewOpenSslDirectory = getBrewOpensslPath();
        if (!brewOpenSslDirectory) {
            throw Error('openssl (brew version) is required but was not found');
        }
        brewOpenSslPath = `${getBrewOpensslPath()}/bin/openssl`;
        if (!node_fs_1.default.existsSync(brewOpenSslPath)) {
            throw Error(`openssl (brew version) is required but was not found at: ${brewOpenSslPath}`);
        }
        else {
            (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `using openssl at: ${brewOpenSslPath}`);
        }
    }
    (0, generalUtils_js_1.ensureDirectory)(mergedOptions.outputDirectory);
    const crtName = url + '.crt';
    const keyName = url + '.key';
    const pfxName = url + '.pfx';
    const sanCnfName = url + '.cnf';
    const filesToCheck = [crtName, keyName, pfxName, sanCnfName];
    for (const file of filesToCheck) {
        const filePath = node_path_1.default.join(mergedOptions.outputDirectory, file);
        if (node_fs_1.default.existsSync(filePath)) {
            throw Error(`${generalUtils_js_1.Emoji.Stop} File ${filePath} already exists. Delete or rename all of the following files from '${mergedOptions.outputDirectory}' if you want to generate a new cert: ${filesToCheck.join(', ')}.`);
        }
    }
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `writing ${sanCnfName} file for use with openssl command`);
    const sanCnfContents = getSanCnfFileContents(url);
    const sanCnfPath = node_path_1.default.join(mergedOptions.outputDirectory, sanCnfName);
    await promises_1.default.writeFile(sanCnfPath, sanCnfContents);
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `attempting to generate cert ${pfxName}`);
    const genKeyAndCrtArgs = `req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes -keyout ${keyName} -out ${crtName} -subj /CN=${url} -config ${sanCnfName}`.split(' ');
    const command = isMac ? brewOpenSslPath : 'openssl';
    let result = await (0, generalUtils_js_1.spawnAsync)(command, genKeyAndCrtArgs, spawnArgs);
    throwIfSpawnResultError(result);
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, 'converting key and crt to pfx');
    const convertToPfxArgs = `pkcs12 -certpbe AES-256-CBC -export -out ${pfxName} -aes256 -inkey ${keyName} -in ${crtName} -password pass:`.split(' ');
    result = await (0, generalUtils_js_1.spawnAsync)(command, convertToPfxArgs, spawnArgs);
    throwIfSpawnResultError(result);
    const pfxPath = node_path_1.default.join(mergedOptions.outputDirectory, pfxName);
    (0, generalUtils_js_1.logIf)(mergedOptions.logSuccess, `${generalUtils_js_1.Emoji.GreenCheck} Successfully generated cert: ${pfxPath}`);
    return pfxPath;
}
exports.generateCertWithOpenSsl = generateCertWithOpenSsl;
/**
 * Uses Powershell to install a cert to the local machine's trusted root store. Must have elevated permissions.
 * If the cert is already installed, this function will do nothing.
 * @param pfxPath The path to the pfx file to install.
 */
async function winInstallCert(pfxPath, options) {
    if (!(0, generalUtils_js_1.isPlatformWindows)()) {
        throw Error('winInstallCert is only supported on Windows');
    }
    validatePfxPath(pfxPath);
    const mergedOptions = { ...defaultCertLogOptions, ...options };
    (0, generalUtils_js_1.logIf)(mergedOptions.logElevatedPermissionsMessage, getRequiresElevatedPermissionsMessage(true));
    if (await winCertIsInstalled({ pfxPath }, mergedOptions)) {
        const certInfo = await winGetPfxInfo(pfxPath);
        (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `${generalUtils_js_1.Emoji.Warning} certificate '${pfxPath}' with subject '${certInfo.subject}' is already installed - to install it again, first uninstall it manually or with the winUninstallCert function`);
        return;
    }
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `installing cert '${pfxPath}'`);
    const psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Import-PfxCertificate -FilePath '${pfxPath}' -CertStoreLocation Cert:\\LocalMachine\\Root`);
    const result = await (0, generalUtils_js_1.spawnAsync)('powershell', psCommandArgs, { stdio: mergedOptions.logSpawnOutput ? 'inherit' : 'pipe' });
    throwIfSpawnResultError(result);
    (0, generalUtils_js_1.logIf)(mergedOptions.logSuccess, `${generalUtils_js_1.Emoji.GreenCheck} Successfully installed cert: ${pfxPath}`);
}
exports.winInstallCert = winInstallCert;
/**
 * Uses Powershell to check if a cert is already installed to the local machine's trusted root store.
 * Uses the subject of the cert in order to avoid false negatives from regenerating the same self-signed cert
 * with the same subject but different thumbprint. Note that this method is geared towards use with certs generated
 * with the {@link generateCertWithOpenSsl} function, so this may not work using subject if your subject is not precisely "`CN=<url>`".
 * @param identifier The subject or path to the pfx file of the cert to check.
 * @returns `true` if the cert is already installed, `false` otherwise.
 */
async function winCertIsInstalled(identifier, options) {
    if (!(0, generalUtils_js_1.isPlatformWindows)()) {
        throw new Error('winCertIsInstalled is only supported on Windows');
    }
    const mergedOptions = { ...defaultCertLogOptions, ...options };
    let psCommandArgs;
    // Get the count of certs installed with the same subject as the one we're trying to install
    if (typeof identifier === 'string') {
        (0, generalUtils_js_1.requireString)('subject', identifier);
        validateSubject(identifier);
        const subject = identifier.startsWith('CN=') ? identifier : `CN=${identifier}`;
        psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Write-Host (Get-ChildItem Cert:\\LocalMachine\\Root | Where-Object { $_.Subject -eq '${subject}' } | Measure-Object).Count`);
    }
    else if ('pfxPath' in identifier) {
        validatePfxPath(identifier.pfxPath);
        psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Write-Host (Get-ChildItem Cert:\\LocalMachine\\Root | Where-Object { $_.Subject -eq (Get-PfxCertificate -FilePath '${identifier.pfxPath}').Subject } | Measure-Object).Count`);
    }
    const tracePart = (typeof identifier === 'string') ? `subject ${identifier}` : `pfxPath ${identifier.pfxPath}`;
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `checking if cert with ${tracePart} is already installed`);
    const result = await (0, generalUtils_js_1.spawnAsync)('powershell', psCommandArgs, { stdio: 'pipe' });
    throwIfSpawnResultError(result);
    const lines = (0, generalUtils_js_1.stringToNonEmptyLines)(result.stdout);
    if (lines.length !== 1) {
        throw new Error(`Unexpected output from powershell command to check if the cert is already installed: ${result.stdout}`);
    }
    return lines[0].trim() !== '0';
}
exports.winCertIsInstalled = winCertIsInstalled;
/**
 * Uses Powershell to uninstall a cert from the local machine's trusted root store. Must have elevated permissions.
 * @param identifier The subject, thumbprint or path to the pfx file of the cert to uninstall.
 * @param options Options for uninstalling the cert.
 */
async function winUninstallCert(identifier, options) {
    if (!(0, generalUtils_js_1.isPlatformWindows)()) {
        throw new Error('winUninstallCert is only supported on Windows');
    }
    const mergedOptions = { ...defaultCertLogOptions, ...options };
    (0, generalUtils_js_1.logIf)(mergedOptions.logElevatedPermissionsMessage, getRequiresElevatedPermissionsMessage(false));
    let psCommandArgs;
    if (typeof identifier === 'string') {
        (0, generalUtils_js_1.requireString)('subject', identifier);
        validateSubject(identifier);
        psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Get-ChildItem Cert:\\LocalMachine\\Root | Where-Object { $_.Subject -match '${identifier}' } | Remove-Item`);
    }
    else if ('thumbprint' in identifier) {
        validateNoQuotes('thumbprint', identifier.thumbprint);
        psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Get-ChildItem Cert:\\LocalMachine\\Root | Where-Object { $_.Thumbprint -eq '${identifier.thumbprint}' } | Remove-Item`);
    }
    else if ('pfxPath' in identifier) {
        validatePfxPath(identifier.pfxPath);
        psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`$thumbprint = (Get-PfxCertificate -FilePath '${identifier.pfxPath}').Thumbprint; Get-ChildItem Cert:\\LocalMachine\\Root | Where-Object { $_.Thumbprint -eq $thumbprint } | Remove-Item`);
    }
    const tracePart = typeof identifier === 'string' ? `'${identifier}'` : JSON.stringify(identifier);
    (0, generalUtils_js_1.logIf)(mergedOptions.logTraceMessages, `uninstalling cert ${tracePart}`);
    const result = await (0, generalUtils_js_1.spawnAsync)('powershell', psCommandArgs, { stdio: mergedOptions.logSpawnOutput ? 'inherit' : 'pipe' });
    throwIfSpawnResultError(result);
    (0, generalUtils_js_1.logIf)(mergedOptions.logSuccess, `${generalUtils_js_1.Emoji.GreenCheck} Successfully uninstalled cert`);
}
exports.winUninstallCert = winUninstallCert;
/**
 * Uses Powershell to get info about a cert.
 * @param pfxPath The path to the pfx file to get info for.
 * @returns The subject, thumbprint and pfxPath of the cert.
 */
async function winGetPfxInfo(pfxPath) {
    if (!(0, generalUtils_js_1.isPlatformWindows)()) {
        throw new Error('winGetPfxInfo is only supported on Windows');
    }
    validatePfxPath(pfxPath);
    const psCommandArgs = (0, generalUtils_js_1.getPowershellHackArgs)(`Get-PfxCertificate -FilePath '${pfxPath}' | Select-Object -Property Subject, Thumbprint, @{Name='PfxPath';Expression={'${pfxPath}'}} | ConvertTo-Json`);
    const result = await (0, generalUtils_js_1.spawnAsync)('powershell', psCommandArgs, { stdio: 'pipe' });
    throwIfSpawnResultError(result);
    const json = result.stdout.trim();
    const parsedJson = JSON.parse(json);
    const certInfo = {
        subject: parsedJson.Subject,
        thumbprint: parsedJson.Thumbprint,
        pfxPath: parsedJson.PfxPath
    };
    return certInfo;
}
exports.winGetPfxInfo = winGetPfxInfo;
/**
 * Does not actually do anything - just outputs the manual instructions for installing a cert for use by chrome on linux.
 */
function linuxInstallCert() {
    const instructions = `Automated linux cert install not supported (chrome does not use system certs without significant extra configuration).
Manual Instructions:
- In Chrome, go to chrome://settings/certificates
- Select Authorities -> import
- Select your generated .crt file (in the ./cert/ directory by default - if you haven't generated it, see the generateCertWithOpenSsl function)
- Check box for "Trust certificate for identifying websites"
- Click OK
- Reload site`;
    console.log(instructions);
}
exports.linuxInstallCert = linuxInstallCert;
function throwIfMaybeBadUrlChars(url, varName = 'url') {
    if (url.includes(' ')) {
        throw Error(`${varName} should not contain spaces`);
    }
    if (url.includes('/')) {
        throw Error(`${varName} should not contain forward slashes`);
    }
    if (url.includes('\\')) {
        throw Error(`${varName} should not contain backslashes`);
    }
}
function getBrewOpensslPath() {
    const brewResult = (0, generalUtils_js_1.simpleSpawnSync)('brew', ['--prefix', 'openssl']);
    if (brewResult.error) {
        throw Error('error attempting to find openssl installed by brew');
    }
    if (brewResult.stdoutLines.length === 0 || brewResult.stdoutLines.length > 1) {
        throw new Error(`unexpected output from brew command 'brew --prefix openssl': ${brewResult.stdout}`);
    }
    return brewResult.stdoutLines[0];
}
function getSanCnfFileContents(url) {
    return sanCnfTemplate.replace(/{{url}}/g, url);
}
function validateSubject(subject) {
    if (subject.includes('\\') || subject.includes('/') || subject.endsWith('.pfx')) {
        throw new Error(`The subject appears to be a file path, which is not allowed. Did you mean to pass something like this instead: { pfxPath: '${subject}' } ?`);
    }
    validateNoQuotes('subject', subject);
}
function validateNoQuotes(name, value) {
    if (value.includes("'") || value.includes('"')) {
        throw new Error(`The value passed for '${name}' contains a single or double quote, which is not allowed.`);
    }
}
function throwIfSpawnResultError(result) {
    if (result.code !== 0) {
        // There won't be any stderr if stdio was set to 'inherit', so we're checking first
        if (result.stderr) {
            console.error((0, colors_js_1.red)('Error:'), result.stderr);
        }
        throw Error(`Spawned command failed with exit code ${result.code}`);
    }
}
function validatePfxPath(pfxPath) {
    if (!pfxPath.endsWith('.pfx')) {
        throw new Error('pfxPath must end with .pfx');
    }
    (0, generalUtils_js_1.requireValidPath)('pfxPath', pfxPath);
    validateNoQuotes('pfxPath', pfxPath);
}
function getRequiresElevatedPermissionsMessage(isInstall = true) {
    return `${generalUtils_js_1.Emoji.Info} Important: ${isInstall ? '' : 'un'}installing a certificate requires elevated permissions`;
}
// Newer cert requirements force the need for "extension info" with DNS and IP info, but openssl v1.x doesn't support that with the
// CLI option -addext, so we're using a san.cnf file instead and passing this into the CLI command with the -config option.
const sanCnfTemplate = `[req]
distinguished_name=req
x509_extensions = v3_req
prompt = no

[req_distinguished_name]
CN = {{url}}

[v3_req]
subjectAltName = @alt_names

[alt_names]
DNS.1 = {{url}}
IP.1 = 127.0.0.1

`;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VydFV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NlcnRVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxzREFBd0I7QUFDeEIsZ0VBQWtDO0FBQ2xDLDBEQUE0QjtBQUM1Qix1REFlMEI7QUFDMUIsMkNBQWlDO0FBZWpDLE1BQU0scUJBQXFCLEdBQW1CO0lBQzVDLGNBQWMsRUFBRSxLQUFLO0lBQ3JCLGdCQUFnQixFQUFFLEtBQUs7SUFDdkIsNkJBQTZCLEVBQUUsSUFBSTtJQUNuQyxVQUFVLEVBQUUsSUFBSTtDQUNqQixDQUFBO0FBV0Q7Ozs7O0dBS0c7QUFDSSxLQUFLLFVBQVUsdUJBQXVCLENBQUMsR0FBVyxFQUFFLE9BQXNDO0lBQy9GLElBQUEsK0JBQWEsRUFBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDekIsdUJBQXVCLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDNUIsTUFBTSxLQUFLLEdBQUcsSUFBQSwrQkFBYSxHQUFFLENBQUE7SUFFN0IsTUFBTSxhQUFhLEdBQXdCLEVBQUUsR0FBRyxxQkFBcUIsRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUE7SUFFOUcsTUFBTSxTQUFTLEdBQW1DLEVBQUUsR0FBRyxFQUFFLGFBQWEsQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUE7SUFFbEosSUFBQSx1QkFBSyxFQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxrQ0FBa0MsQ0FBQyxDQUFBO0lBRXpFLElBQUksZUFBZSxHQUFXLEVBQUUsQ0FBQTtJQUNoQyxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1YsTUFBTSxXQUFXLEdBQUcsSUFBQSwyQkFBUyxFQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQTtRQUNqRCxJQUFJLENBQUMsV0FBVyxF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